name: Fetch and cache coding stats

on:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours
  workflow_dispatch: {}

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Fetch Codeforces
        run: |
          mkdir -p public/data
          curl -s "https://codeforces.com/api/user.info?handles=mishurahman" -o public/data/stats_cf.json || echo '{}' > public/data/stats_cf.json

      - name: Fetch LeetCode quick stats
        run: |
          curl -s "https://leetcode-stats-api.herokuapp.com/mishurahman" -o public/data/stats_lc.json || echo '{}' > public/data/stats_lc.json

      - name: Fetch LeetCode GraphQL (contest/badges)
        run: |
          mkdir -p public/data
          graphql='{"query":"query { userContestRanking(username: \"mishurahman\") { attendedContestsCount rating globalRanking totalParticipants topPercentage } }"}'
          curl -s -H "Content-Type: application/json" -d "$graphql" https://leetcode.com/graphql -o public/data/stats_lc_graphql.json || echo '{}' > public/data/stats_lc_graphql.json

      - name: Merge into single stats.json
        run: |
          python - <<'PY'
import json
def load(path):
    try:
        with open(path) as f:
            return json.load(f)
    except Exception:
        return None

cf = load('public/data/stats_cf.json')
lc = load('public/data/stats_lc.json')
lcg = load('public/data/stats_lc_graphql.json')
out = { 'codeforces': cf, 'leetcode_api': lc, 'leetcode_graph': lcg }
with open('public/data/stats.json','w') as f:
    json.dump(out, f, indent=2)
print('Wrote public/data/stats.json')
PY

      - name: Commit and push cached data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add public/data/stats.json || true
          git commit -m "chore: update cached stats" || echo "No changes to commit"
          git push || echo "Push failed"
